name: Build and Release State Tax Form Crawler
on:
  push:
    branches:
      - "master"
      - "staging"
      - "development"
    paths:
      - "state-tax/state-tax-form-crawler/src/**"
  workflow_dispatch:
    inputs:
      chosen_env:
        type: choice
        description: Which environment to deploy?
        required: true
        default: 'dev'
        options:
          - dev
          - staging
          - prod
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  LAMBDA_NAME: state-tax-form-crawler
  SESSION_NAME: GithubActionAssumeRole
  WORKING_DIR: state-tax/state-tax-form-crawler/src
  ROLE_ARN: arn:aws:iam::654654273398:role/GithubAction
  AWS_REGION: us-west-2
  DEV_ACCOUNT: 654654273398
  STAGING_ACCOUNT: 654654273398
  PROD_ACCOUNT: 654654273398

jobs:
  set-deploy-env:
    runs-on: ubuntu-latest
    outputs:
      account: ${{ steps.set-account.outputs.account }}
      branch: ${{ steps.set-branch.outputs.branch }}
    steps:
      - name: Set Github branch
        id: set-branch
        run: |
          if ${{ inputs.chosen_env == 'dev' }}; then
            echo "branch=development" >> $GITHUB_OUTPUT
          elif ${{ inputs.chosen_env == 'staging' }}; then
            echo "branch=staging" >> $GITHUB_OUTPUT
          elif ${{ inputs.chosen_env == 'prod' }}; then
            echo "branch=master" >> $GITHUB_OUTPUT
          elif ${{ github.event_name == 'push' }}; then
            echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "Unsupported event '${{ github.event_name }}' for deployment."
            exit 1
          fi
      - name: Set AWS account id
        id: set-account
        run: |
          branch=${{ steps.set-branch.outputs.branch }}

          if [ "$branch" == "development" ]; then
            echo "account=${{ env.DEV_ACCOUNT }}" >> $GITHUB_OUTPUT
          elif [ "$branch" == "staging" ]; then
            echo "account=${{ env.STAGING_ACCOUNT }}" >> $GITHUB_OUTPUT
          elif [ "$branch" == "master" ]; then
            echo "account=${{ env.PROD_ACCOUNT }}" >> $GITHUB_OUTPUT
          else
            echo "Unsupported branch '$branch' for deployment."
            exit 1
          fi
      - name: Debug variables
        run: |
          echo "chosen env: ${{ inputs.chosen_env }}"
          echo "deploy branch: ${{ steps.set-branch.outputs.branch }}"
          echo "github.event_name: ${{ github.event_name }}"
          echo "github.ref: ${{ github.ref }}"
  build-and-upload:
    needs: set-deploy-env
    runs-on: ubuntu-latest
    ## JWT Permissions required by GH
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.set-deploy-env.outputs.branch }}
          fetch-depth: 0
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ env.ROLE_ARN }}
          role-session-name: ${{ env.SESSION_NAME }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Use Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: pip install -r requirements.txt -t ../lib --upgrade
      - name: Package lambda function
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          cp -r . ../lib
          cd ../lib
          zip -r ../function.zip .
          ls -al ../function.zip  # Verify the zip file creation
          cd .. && rm -rf lib
      - name: Check AWS identity
        run: |
          aws sts get-caller-identity
      - name: Upload lambda to AWS (DEV)
        working-directory: ${{ env.WORKING_DIR }}
        env:
          FUNCTION_NAME: arn:aws:lambda:us-west-2:${{ needs.set-deploy-env.outputs.account }}:function:${{ env.LAMBDA_NAME }}
        run: |
          aws lambda update-function-code --function-name $FUNCTION_NAME --zip-file fileb://../function.zip
